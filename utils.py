"""
–ú–æ–¥—É–ª—å —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ —É—Ç–∏–ª–∏—Ç–∞–º–∏ –∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –¥–ª—è –±–æ—Ç–∞.
–í–∫–ª—é—á–∞–µ—Ç –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä, –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫, –∏–≥—Ä—ã –∏ –¥—Ä—É–≥–∏–µ –ø–æ–ª–µ–∑–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏.
"""

import re
import random
import requests
from typing import Optional, Tuple, List, Dict, Any
from datetime import datetime

from logger import log_info, log_error
from gemini_client import gemini_client


class Calculator:
    """–ü—Ä–æ—Å—Ç–æ–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–ª—è –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π."""

    def evaluate_expression(self, expression: str) -> Optional[float]:
        """
        –í—ã—á–∏—Å–ª—è–µ—Ç –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ.

        Args:
            expression: –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ

        Returns:
            float: –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ
        """
        try:
            # –û—á–∏—â–∞–µ–º –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
            expression = re.sub(r'[^\d+\-*/().\s]', '', expression)

            # –ó–∞–º–µ–Ω—è–µ–º –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            expression = expression.replace('^', '**')

            # –í—ã—á–∏—Å–ª—è–µ–º
            result = eval(expression, {"__builtins": {}})

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç - —á–∏—Å–ª–æ
            if isinstance(result, (int, float)):
                return float(result)

        except Exception as e:
            log_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏—è '{expression}': {str(e)}")
            return None

        return None


class Translator:
    """–ü—Ä–æ—Å—Ç–æ–π –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö API."""

    SUPPORTED_LANGUAGES = {
        'uz': '—É–∑–±–µ–∫—Å–∫–∏–π',
        'ru': '—Ä—É—Å—Å–∫–∏–π',
        'en': '–∞–Ω–≥–ª–∏–π—Å–∫–∏–π',
        'es': '–∏—Å–ø–∞–Ω—Å–∫–∏–π',
        'fr': '—Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π',
        'de': '–Ω–µ–º–µ—Ü–∫–∏–π',
        'it': '–∏—Ç–∞–ª—å—è–Ω—Å–∫–∏–π',
        'pt': '–ø–æ—Ä—Ç—É–≥–∞–ª—å—Å–∫–∏–π',
        'zh': '–∫–∏—Ç–∞–π—Å–∫–∏–π',
        'ja': '—è–ø–æ–Ω—Å–∫–∏–π',
        'ko': '–∫–æ—Ä–µ–π—Å–∫–∏–π'
    }

    def translate_text(self, text: str, target_lang: str = 'en') -> Optional[str]:
        """
        –ü–µ—Ä–µ–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π —è–∑—ã–∫ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Google Translate API.

        Args:
            text: –¢–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞
            target_lang: –¶–µ–ª–µ–≤–æ–π —è–∑—ã–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∞–Ω–≥–ª–∏–π—Å–∫–∏–π)

        Returns:
            str: –ü–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ
        """
        try:
            log_info(f"–ü–µ—Ä–µ–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ {target_lang}: {text[:50]}...")

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —è–∑—ã–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
            if target_lang not in self.SUPPORTED_LANGUAGES:
                return f"‚ùå –Ø–∑—ã–∫ '{target_lang}' –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è."

            # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º Google Translate —á–µ—Ä–µ–∑ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø—Ä–æ–∫—Å–∏
            # –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π API
            translation = self._translate_with_google(text, target_lang)

            if translation:
                return translation
            else:
                # Fallback –Ω–∞ mock-–ø–µ—Ä–µ–≤–æ–¥
                return text

        except Exception as e:
            log_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ —Ç–µ–∫—Å—Ç–∞: {str(e)}")
            return None

    def _translate_with_google(self, text: str, target_lang: str) -> Optional[str]:
        """
        –ü–µ—Ä–µ–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ Google Translate API (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π).

        Args:
            text: –¢–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞
            target_lang: –¶–µ–ª–µ–≤–æ–π —è–∑—ã–∫

        Returns:
            str: –ü–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–ª–∏ None
        """
        try:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π Google Translate API
            url = "https://translate.googleapis.com/translate_a/single"
            params = {
                'client': 'gtx',
                'sl': 'auto',  # –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —è–∑—ã–∫–∞
                'tl': target_lang,  # –¶–µ–ª–µ–≤–æ–π —è–∑—ã–∫
                'dt': 't',  # –¢–∏–ø –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                'q': text
            }

            response = requests.get(url, params=params, timeout=10)
            response.raise_for_status()

            data = response.json()

            # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–∑ –æ—Ç–≤–µ—Ç–∞
            if data and len(data) > 0 and len(data[0]) > 0:
                translated_text = ""
                for item in data[0]:
                    if item and len(item) > 0:
                        translated_text += item[0]

                if translated_text.strip():
                    return translated_text

            return None

        except requests.exceptions.RequestException as e:
            log_error(f"–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ: {str(e)}")
            return None
        except Exception as e:
            log_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–µ—Ä–µ–≤–æ–¥–∞: {str(e)}")
            return None


class WeatherService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–≥–æ–¥–µ —á–µ—Ä–µ–∑ Open-Meteo API."""

    # –°–ª–æ–≤–∞—Ä—å —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤ –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω–∞
    CITY_COORDINATES = {
        "—Ç–∞—à–∫–µ–Ω—Ç": (41.2995, 69.2401),
        "—Å–∞–º–∞—Ä–∫–∞–Ω–¥": (39.6542, 66.9597),
        "–±—É—Ö–∞—Ä–∞": (39.7748, 64.4286),
        "–∞–Ω–¥–∏–∂–∞–Ω": (40.7833, 72.3333),
        "—Ñ–µ—Ä–≥–∞–Ω–∞": (40.3734, 71.7978),
        "–Ω–∞–º–∞–Ω—Ç–∞–Ω": (40.9983, 71.6726),
        "–∫–∞—Ä—à–∏": (38.8352, 65.7842),
        "—Ç–µ—Ä–º–µ–∑": (37.2242, 67.2783),
        "–Ω—É–∫—É—Å": (42.4531, 59.6103),
        "—É—Ä–≥–µ–Ω—á": (41.5534, 60.6317),
        "–Ω–∞–≤–æ–∏": (40.0844, 65.3792),
        "–≥—É–ª–∏—Å—Ç–∞–Ω": (40.4897, 68.7844),
        "—á–∏—Ä—á–∏–∫": (41.4697, 69.5822),
        "–¥–∂–∏–∑–∞–∫": (40.1158, 67.8422),
        "–∫–æ–∫–∞–Ω–¥": (40.5286, 70.9428),
        "–∞–Ω–≥—Ä–µ–Ω": (41.0167, 70.1436),
        "–∞–ª–º–∞–ª—ã–∫": (40.8667, 69.6),
        "–±–µ–∫–æ–±–æ–¥": (40.2208, 69.2697),
        "—á–∏—Ä–∞–∫—á–∏": (41.4833, 69.55),
        "–ø–∞—Ä–∫–µ–Ω—Ç": (41.3, 69.6833),
        "—è–Ω–≥–∏—é–ª—å": (41.1121, 69.0708),
        "–∫–∏–±—Ä–∞–π": (41.3833, 69.45),
        "–±—É–∫–∞": (40.8, 69.1833),
        "–±–µ–∫–∞–±–∞–¥": (40.2167, 69.2833),
        "–∑—É–ª—Ñ–∏–∫–∞—Ä": (41.2167, 69.2167),
        "—Ç–∞—à–∫–µ–Ω—Ç—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": (41.2995, 69.2401),  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¢–∞—à–∫–µ–Ω—Ç
        "–∫–∞—Ä–∞–∫–∞–ª–ø–∞–∫—Å—Ç–∞–Ω": (42.4531, 59.6103),  # –ù—É–∫—É—Å
        "—Ö–æ—Ä–µ–∑–º": (41.5534, 60.6317),  # –£—Ä–≥–µ–Ω—á
        "–∫–∞—à–∫–∞–¥–∞—Ä—å—è": (38.8352, 65.7842),  # –ö–∞—Ä—à–∏
        "—Å—É—Ä—Ö–∞–Ω–¥–∞—Ä—å—è": (37.2242, 67.2783),  # –¢–µ—Ä–º–µ–∑
        "—Å—ã—Ä–¥–∞—Ä—å—è": (40.4897, 68.7844),  # –ì—É–ª–∏—Å—Ç–∞–Ω
        "–Ω–∞–º–∞–Ω–≥–∞–Ω": (40.9983, 71.6726),  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
        "–¥–∂–∏–∑–∞–∫": (40.1158, 67.8422),
    }

    def get_weather(self, city: str) -> Optional[str]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–≥–æ–¥–µ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞ —á–µ—Ä–µ–∑ Open-Meteo API.

        Args:
            city: –ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞

        Returns:
            str: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–≥–æ–¥–µ –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ
        """
        try:
            log_info(f"–ó–∞–ø—Ä–æ—Å —Ä–µ–∞–ª—å–Ω–æ–π –ø–æ–≥–æ–¥—ã –¥–ª—è –≥–æ—Ä–æ–¥–∞: {city}")

            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≥–æ—Ä–æ–¥–∞
            coords = self._get_city_coordinates(city)
            if not coords:
                return f"‚ùå –ì–æ—Ä–æ–¥ '{city}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.\n\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –≥–æ—Ä–æ–¥–∞: –¢–∞—à–∫–µ–Ω—Ç, –°–∞–º–∞—Ä–∫–∞–Ω–¥, –ë—É—Ö–∞—Ä–∞, –ê–Ω–¥–∏–∂–∞–Ω, –§–µ—Ä–≥–∞–Ω–∞, –ù–∞–º–∞–Ω–≥–∞–Ω, –ö–∞—Ä—à–∏, –¢–µ—Ä–º–µ–∑, –ù—É–∫—É—Å, –£—Ä–≥–µ–Ω—á, –ù–∞–≤–æ–∏, –ì—É–ª–∏—Å—Ç–∞–Ω, –ß–∏—Ä—á–∏–∫ –∏ –¥—Ä—É–≥–∏–µ."

            latitude, longitude = coords

            # –ó–∞–ø—Ä–æ—Å –∫ Open-Meteo API (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π, –±–µ–∑ API –∫–ª—é—á–∞)
            url = "https://api.open-meteo.com/v1/forecast"
            params = {
                "latitude": latitude,
                "longitude": longitude,
                "current_weather": True,
                "hourly": "temperature_2m,relativehumidity_2m,windspeed_10m",
                "timezone": "Asia/Tashkent"
            }

            response = requests.get(url, params=params, timeout=10)
            response.raise_for_status()

            data = response.json()

            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–≥–æ–¥—É
            current = data.get("current_weather", {})
            if not current:
                return f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ –¥–ª—è –≥–æ—Ä–æ–¥–∞ {city}"

            temperature = current.get("temperature", "N/A")
            windspeed = current.get("windspeed", "N/A")
            winddirection = current.get("winddirection", "N/A")

            # –ü–æ–ª—É—á–∞–µ–º –≤–ª–∞–∂–Ω–æ—Å—Ç—å –∏–∑ –ø–æ—á–∞—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            hourly = data.get("hourly", {})
            humidity = "N/A"
            if hourly.get("relativehumidity_2m"):
                humidity = hourly["relativehumidity_2m"][0]

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–≥–æ–¥—ã –ø–æ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ –∏ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏
            weather_description = self._get_weather_description(temperature, humidity)

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ç—Ä–∞
            wind_direction_text = self._get_wind_direction(winddirection)

            return f"üå§Ô∏è <b>–ü–æ–≥–æ–¥–∞ –≤ {city.title()}</b>\n\n" \
                   f"üå°Ô∏è <b>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</b> {temperature}¬∞C\n" \
                   f"üå•Ô∏è <b>–°–æ—Å—Ç–æ—è–Ω–∏–µ:</b> {weather_description}\n" \
                   f"üíß <b>–í–ª–∞–∂–Ω–æ—Å—Ç—å:</b> {humidity}%\n" \
                   f"üí® <b>–í–µ—Ç–µ—Ä:</b> {windspeed} –º/—Å {wind_direction_text}\n\n" \
                   f"<i>üìä –î–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã Open-Meteo (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)</i>"

        except requests.exceptions.RequestException as e:
            log_error(f"–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –ø–æ–≥–æ–¥—ã –¥–ª—è {city}: {str(e)}")
            return f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–∏—Å—É –ø–æ–≥–æ–¥—ã.\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        except Exception as e:
            log_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–≥–æ–¥—ã –¥–ª—è {city}: {str(e)}")
            return f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–≥–æ–¥—É –¥–ª—è –≥–æ—Ä–æ–¥–∞ {city}."

    def _get_city_coordinates(self, city: str) -> Optional[Tuple[float, float]]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≥–æ—Ä–æ–¥–∞ –∏–∑ —Å–ª–æ–≤–∞—Ä—è.

        Args:
            city: –ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞

        Returns:
            Tuple[float, float]: (latitude, longitude) –∏–ª–∏ None
        """
        city_lower = city.lower().strip()

        # –ü—Ä—è–º–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
        if city_lower in self.CITY_COORDINATES:
            return self.CITY_COORDINATES[city_lower]

        # –ü–æ–∏—Å–∫ –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é
        for city_name, coords in self.CITY_COORDINATES.items():
            if city_lower in city_name or city_name in city_lower:
                return coords

        return None

    def _get_weather_description(self, temperature: float, humidity: int) -> str:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–≥–æ–¥—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –∏ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏.

        Args:
            temperature: –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ –≥—Ä–∞–¥—É—Å–∞—Ö –¶–µ–ª—å—Å–∏—è
            humidity: –í–ª–∞–∂–Ω–æ—Å—Ç—å –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö

        Returns:
            str: –û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–≥–æ–¥—ã
        """
        if temperature >= 25:
            return "–∂–∞—Ä–∫–æ, —Å–æ–ª–Ω–µ—á–Ω–æ"
        elif temperature >= 15:
            return "—Ç–µ–ø–ª–æ, –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ"
        elif temperature >= 5:
            return "–ø—Ä–æ—Ö–ª–∞–¥–Ω–æ"
        elif temperature >= -5:
            return "—Ö–æ–ª–æ–¥–Ω–æ"
        else:
            return "–æ—á–µ–Ω—å —Ö–æ–ª–æ–¥–Ω–æ, –º–æ—Ä–æ–∑"

    def _get_wind_direction(self, degrees: float) -> str:
        """
        –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ç—Ä–∞ –∏–∑ –≥—Ä–∞–¥—É—Å–æ–≤ –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ.

        Args:
            degrees: –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ç—Ä–∞ –≤ –≥—Ä–∞–¥—É—Å–∞—Ö

        Returns:
            str: –¢–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        """
        if degrees is None:
            return ""

        directions = [
            "—Å–µ–≤–µ—Ä–Ω—ã–π", "—Å–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ—á–Ω—ã–π", "–≤–æ—Å—Ç–æ—á–Ω—ã–π", "—é–≥–æ-–≤–æ—Å—Ç–æ—á–Ω—ã–π",
            "—é–∂–Ω—ã–π", "—é–≥–æ-–∑–∞–ø–∞–¥–Ω—ã–π", "–∑–∞–ø–∞–¥–Ω—ã–π", "—Å–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥–Ω—ã–π"
        ]

        index = round(degrees / 45) % 8
        return directions[index]


class GameService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∏–≥—Ä."""

    def play_rps(self, user_choice: str) -> str:
        """
        –ò–≥—Ä–∞ –∫–∞–º–µ–Ω—å-–Ω–æ–∂–Ω–∏—Ü—ã-–±—É–º–∞–≥–∞.

        Args:
            user_choice: –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (rock/scissors/paper –∏–ª–∏ –∫–∞–º–µ–Ω—å/–Ω–æ–∂–Ω–∏—Ü—ã/–±—É–º–∞–≥–∞)

        Returns:
            str: –†–µ–∑—É–ª—å—Ç–∞—Ç –∏–≥—Ä—ã
        """
        # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –≤ —Ä—É—Å—Å–∫–∏–µ
        choice_map = {
            'rock': '–∫–∞–º–µ–Ω—å',
            'scissors': '–Ω–æ–∂–Ω–∏—Ü—ã',
            'paper': '–±—É–º–∞–≥–∞'
        }

        # –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –≤–∞—Ä–∏–∞–Ω—Ç, –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º
        if user_choice.lower() in choice_map:
            user_choice = choice_map[user_choice.lower()]

        choices = ['–∫–∞–º–µ–Ω—å', '–Ω–æ–∂–Ω–∏—Ü—ã', '–±—É–º–∞–≥–∞']
        user_choice = user_choice.lower().strip()

        if user_choice not in choices:
            return "‚ùå –í—ã–±–µ—Ä–∏—Ç–µ: –∫–∞–º–µ–Ω—å, –Ω–æ–∂–Ω–∏—Ü—ã –∏–ª–∏ –±—É–º–∞–≥–∞!"

        bot_choice = random.choice(choices)

        result = ""
        if user_choice == bot_choice:
            result = "ü§ù –ù–∏—á—å—è!"
        elif (user_choice == '–∫–∞–º–µ–Ω—å' and bot_choice == '–Ω–æ–∂–Ω–∏—Ü—ã') or \
             (user_choice == '–Ω–æ–∂–Ω–∏—Ü—ã' and bot_choice == '–±—É–º–∞–≥–∞') or \
             (user_choice == '–±—É–º–∞–≥–∞' and bot_choice == '–∫–∞–º–µ–Ω—å'):
            result = "üéâ –¢—ã –ø–æ–±–µ–¥–∏–ª!"
        else:
            result = "üò¢ –Ø –ø–æ–±–µ–¥–∏–ª!"

        return f"ü§ñ –Ø –≤—ã–±—Ä–∞–ª: {bot_choice}\nüßë –¢—ã –≤—ã–±—Ä–∞–ª: {user_choice}\n\n{result}"

    def guess_number_game(self, difficulty: str = 'medium') -> Tuple[str, int]:
        """
        –ù–∞—á–∏–Ω–∞–µ—Ç –∏–≥—Ä—É —É–≥–∞–¥–∞–π —á–∏—Å–ª–æ —Å AI-–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏.

        Args:
            difficulty: –°–ª–æ–∂–Ω–æ—Å—Ç—å (easy/medium/hard)

        Returns:
            Tuple[str, int]: –°–æ–æ–±—â–µ–Ω–∏–µ –∏ –∑–∞–≥–∞–¥–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ
        """
        ranges = {
            'easy': (1, 10),
            'medium': (1, 100),
            'hard': (1, 1000)
        }

        min_val, max_val = ranges.get(difficulty, (1, 100))
        number = random.randint(min_val, max_val)

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É —á–µ—Ä–µ–∑ Gemini
        try:
            hint_prompt = f"–î–∞–π –æ–¥–Ω—É –∫–æ—Ä–æ—Ç–∫—É—é –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É –∏–ª–∏ —Ñ–∞–∫—Ç –ø—Ä–æ —á–∏—Å–ª–æ {number}. –ú–∞–∫—Å–∏–º—É–º 2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."
            hint = gemini_client.generate_text_response(hint_prompt)
            if hint:
                hint = hint.strip()
                if len(hint) > 100:
                    hint = hint[:100] + "..."
            else:
                hint = "–≠—Ç–æ —á–∏—Å–ª–æ –∏–º–µ–µ—Ç —Å–≤–æ—é —É–Ω–∏–∫–∞–ª—å–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é!"
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è —á–∏—Å–ª–∞ {number}: {e}")
            hint = "–ü–æ–ø—Ä–æ–±—É–π —É–≥–∞–¥–∞—Ç—å –º–µ—Ç–æ–¥–æ–º –ø–æ–ª–æ–≤–∏–Ω–Ω–æ–≥–æ –¥–µ–ª–µ–Ω–∏—è!"

        difficulty_names = {
            'easy': '–õ–µ–≥–∫–∏–π',
            'medium': '–°—Ä–µ–¥–Ω–∏–π',
            'hard': '–°–ª–æ–∂–Ω—ã–π'
        }

        difficulty_name = difficulty_names.get(difficulty, '–°—Ä–µ–¥–Ω–∏–π')

        message = f"üî¢ <b>–ò–≥—Ä–∞: –£–≥–∞–¥–∞–π —á–∏—Å–ª–æ!</b>\n\nüéØ –ó–∞–≥–∞–¥–∞–ª —á–∏—Å–ª–æ –æ—Ç {min_val} –¥–æ {max_val}\nüìä –°–ª–æ–∂–Ω–æ—Å—Ç—å: {difficulty_name}\nüí° <b>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</b> {hint}\n\n–ü–æ–ø—Ä–æ–±—É–π —É–≥–∞–¥–∞—Ç—å! üé≤"

        return message, number

    def check_guess(self, guess: int, target: int) -> str:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É–≥–∞–¥–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ.

        Args:
            guess: –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–æ–µ —á–∏—Å–ª–æ
            target: –ó–∞–≥–∞–¥–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ

        Returns:
            str: –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
        """
        if guess < target:
            return "üìà –ó–∞–≥–∞–¥–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ –±–æ–ª—å—à–µ! ‚¨ÜÔ∏è"
        elif guess > target:
            return "üìâ –ó–∞–≥–∞–¥–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ –º–µ–Ω—å—à–µ! ‚¨áÔ∏è"
        else:
            return "üéâ –ü—Ä–∞–≤–∏–ª—å–Ω–æ! –¢—ã —É–≥–∞–¥–∞–ª! üéä"

    def play_dice_game(self, bet: str = 'medium') -> str:
        """–ò–≥—Ä–∞ –≤ –∫–æ—Å—Ç–∏."""
        try:
            bets = {
                'low': (1, 3),
                'medium': (4, 10),
                'high': (11, 18)
            }

            min_bet, max_bet = bets.get(bet, (4, 10))
            user_dice = random.randint(min_bet, max_bet)
            bot_dice = random.randint(min_bet, max_bet)

            result = ""
            if user_dice > bot_dice:
                result = "üéâ –¢—ã –ø–æ–±–µ–¥–∏–ª! üé≤"
            elif user_dice < bot_dice:
                result = "üò¢ –Ø –ø–æ–±–µ–¥–∏–ª! üé≤"
            else:
                result = "ü§ù –ù–∏—á—å—è! üé≤"

            return f"üéØ <b>–ò–≥—Ä–∞ –≤ –∫–æ—Å—Ç–∏</b>\n\n" \
                   f"–¢–≤–æ–∏ –∫–æ—Å—Ç–∏: {user_dice}\n" \
                   f"–ú–æ–∏ –∫–æ—Å—Ç–∏: {bot_dice}\n\n" \
                   f"{result}"
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞ –≤ –∏–≥—Ä–µ: {str(e)}"

    def get_random_question(self) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π –≤–æ–ø—Ä–æ—Å –¥–ª—è –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã."""
        questions = [
            ("–ö–∞–∫–∞—è –ø–ª–∞–Ω–µ—Ç–∞ –±–ª–∏–∂–µ –≤—Å–µ–≥–æ –∫ –°–æ–ª–Ω—Ü—É?", ["–ú–µ—Ä–∫—É—Ä–∏–π", "–í–µ–Ω–µ—Ä–∞", "–ó–µ–º–ª—è", "–ú–∞—Ä—Å"]),
            ("–ö–∞–∫–æ–π —ç–ª–µ–º–µ–Ω—Ç –∏–º–µ–µ—Ç —Ö–∏–º–∏—á–µ—Å–∫–∏–π —Å–∏–º–≤–æ–ª 'O'?", ["–ö–∏—Å–ª–æ—Ä–æ–¥", "–ó–æ–ª–æ—Ç–æ", "–°–µ—Ä–µ–±—Ä–æ", "–£–≥–ª–µ—Ä–æ–¥"]),
            ("–í –∫–∞–∫–æ–º –≥–æ–¥—É –±—ã–ª–∞ –æ—Å–Ω–æ–≤–∞–Ω–∞ –∫–æ–º–ø–∞–Ω–∏—è Apple?", ["1976", "1980", "1970", "1985"]),
            ("–ö–∞–∫–∞—è —Ä–µ–∫–∞ —Å–∞–º–∞—è –¥–ª–∏–Ω–Ω–∞—è –≤ –º–∏—Ä–µ?", ["–ê–º–∞–∑–æ–Ω–∫–∞", "–ù–∏–ª", "–Ø–Ω—Ü–∑—ã", "–ú–∏—Å—Å–∏—Å–∏–ø–∏"]),
            ("–°–∫–æ–ª—å–∫–æ –∫–æ–Ω—Ç–∏–Ω–µ–Ω—Ç–æ–≤ –Ω–∞ –ó–µ–º–ª–µ?", ["7", "6", "5", "8"]),
            ("–ö–∞–∫–æ–π —è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π?", ["Python", "JavaScript", "Java", "C++"]),
            ("–ö–∞–∫–∞—è —Å—Ç—Ä–∞–Ω–∞ —Å–∞–º–∞—è –±–æ–ª—å—à–∞—è –ø–æ –ø–ª–æ—â–∞–¥–∏?", ["–†–æ—Å—Å–∏—è", "–ö–∞–Ω–∞–¥–∞", "–ö–∏—Ç–∞–π", "–°–®–ê"]),
            ("–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–ø—É—Ç–Ω–∏–∫ –ó–µ–º–ª–∏?", ["–õ—É–Ω–∞", "–ò–æ", "–ï–≤—Ä–æ–ø–∞", "–ì–∞–Ω–∏–º–µ–¥"])
        ]

        question, options = random.choice(questions)
        options_text = "\n".join([f"{i+1}. {opt}" for i, opt in enumerate(options)])

        return f"üß† <b>–í–∏–∫—Ç–æ—Ä–∏–Ω–∞!</b>\n\n‚ùì {question}\n\n{options_text}\n\n–û—Ç–≤–µ—Ç—å –Ω–æ–º–µ—Ä–æ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞!"

    def generate_quiz_question(self) -> Optional[Dict[str, Any]]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤–æ–ø—Ä–æ—Å –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã —Å –ø–æ–º–æ—â—å—é Gemini AI.

        Returns:
            Dict —Å –≤–æ–ø—Ä–æ—Å–æ–º, –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–æ–≤ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –æ—Ç–≤–µ—Ç–æ–º –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ
        """
        try:
            prompt = """–°–æ–∑–¥–∞–π –æ–¥–∏–Ω –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –ø–æ —Å–ª—É—á–∞–π–Ω–æ–π —Ç–µ–º–µ (–∏—Å—Ç–æ—Ä–∏—è, –Ω–∞—É–∫–∞, –≥–µ–æ–≥—Ä–∞—Ñ–∏—è, –∏—Å–∫—É—Å—Å—Ç–≤–æ, —Å–ø–æ—Ä—Ç, –∫–∏–Ω–æ –∏ —Ç.–¥.).

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
1. –í–æ–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º –∏ –ø–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—å–Ω—ã–º
2. –î–∞–π 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞ (1, 2, 3, 4)
3. –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
4. –£–∫–∞–∂–∏ –Ω–æ–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
5. –î–æ–±–∞–≤—å –Ω–µ–±–æ–ª—å—à—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É –∏–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
–í–æ–ø—Ä–æ—Å: [–≤–æ–ø—Ä–æ—Å]
1. [–≤–∞—Ä–∏–∞–Ω—Ç 1]
2. [–≤–∞—Ä–∏–∞–Ω—Ç 2]
3. [–≤–∞—Ä–∏–∞–Ω—Ç 3]
4. [–≤–∞—Ä–∏–∞–Ω—Ç 4]
–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: [–Ω–æ–º–µ—Ä]
–ü–æ–¥—Å–∫–∞–∑–∫–∞: [–∫—Ä–∞—Ç–∫–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞]"""

            response = gemini_client.generate_text_response(prompt)

            if response:
                # –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç Gemini
                lines = response.strip().split('\n')
                question = ""
                options = []
                correct_answer = ""
                hint = ""

                current_section = ""
                for line in lines:
                    line = line.strip()
                    if line.startswith('–í–æ–ø—Ä–æ—Å:'):
                        question = line.replace('–í–æ–ø—Ä–æ—Å:', '').strip()
                        current_section = "question"
                    elif line.startswith(('1.', '2.', '3.', '4.')):
                        option = line[3:].strip()
                        options.append(option)
                    elif line.startswith('–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:'):
                        correct_answer = line.replace('–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:', '').strip()
                    elif line.startswith('–ü–æ–¥—Å–∫–∞–∑–∫–∞:'):
                        hint = line.replace('–ü–æ–¥—Å–∫–∞–∑–∫–∞:', '').strip()

                if question and len(options) == 4 and correct_answer:
                    return {
                        'question': question,
                        'options': options,
                        'correct_answer': correct_answer,
                        'hint': hint if hint else "–ü–æ–¥—Å–∫–∞–∑–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"
                    }

        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–æ–ø—Ä–æ—Å–∞ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã: {e}")

        return None

    def check_quiz_answer(self, question: str, user_answer: str, correct_answer: str) -> str:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã."""
        try:
            answer_num = int(user_answer.strip())
            if 1 <= answer_num <= 4:
                if str(answer_num) == correct_answer:
                    return "üéâ –ü—Ä–∞–≤–∏–ª—å–Ω–æ! –¢—ã —É–º–Ω–∏—Ü–∞! üß†"
                else:
                    return "‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ, –Ω–æ –Ω–µ —Ä–∞—Å—Å—Ç—Ä–∞–∏–≤–∞–π—Å—è! –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑."
            else:
                return "‚ùå –í–≤–µ–¥–∏ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 4!"
        except ValueError:
            return "‚ùå –í–≤–µ–¥–∏ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 4!"

    def get_magic_ball_answer(self, user_question: str = "") -> str:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –æ—Ç–≤–µ—Ç –≤–æ–ª—à–µ–±–Ω–æ–≥–æ —à–∞—Ä–∞ —á–µ—Ä–µ–∑ Gemini AI.

        Args:
            user_question: –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è –±–æ–ª–µ–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞)

        Returns:
            str: –ö—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –æ—Ç–≤–µ—Ç –≤–æ–ª—à–µ–±–Ω–æ–≥–æ —à–∞—Ä–∞
        """
        try:
            # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Å—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–∞
            styles = [
                "–∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –∏ —é–º–æ—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π",
                "–∑–∞–≥–∞–¥–æ—á–Ω—ã–π –∏ –º–∏—Å—Ç–∏—á–µ—Å–∫–∏–π",
                "–º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π –∏ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π",
                "—Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–π –∏ –≥–ª—É–±–æ–∫–∏–π",
                "–∏–≥—Ä–∏–≤—ã–π –∏ –ª–µ–≥–∫–æ–º—ã—Å–ª–µ–Ω–Ω—ã–π"
            ]

            style = random.choice(styles)

            if user_question and len(user_question.strip()) > 5:
                prompt = f"""–î–∞–π –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –æ—Ç–≤–µ—Ç –≤–æ–ª—à–µ–±–Ω–æ–≥–æ —à–∞—Ä–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å: "{user_question.strip()[:100]}..."

–°—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–∞: {style}
–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫—Ä–∞—Ç–∫–∏–º (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–º–æ–¥–∑–∏ –≤–æ–ª—à–µ–±–Ω–æ–≥–æ —à–∞—Ä–∞ üé±
- –ë—ã—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º
- –ù–µ –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º
- –ù–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ"""
            else:
                prompt = f"""–î–∞–π –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –æ—Ç–≤–µ—Ç –≤–æ–ª—à–µ–±–Ω–æ–≥–æ —à–∞—Ä–∞ –≤ —Å—Ç–∏–ª–µ: {style}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫—Ä–∞—Ç–∫–∏–º (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–º–æ–¥–∑–∏ –≤–æ–ª—à–µ–±–Ω–æ–≥–æ —à–∞—Ä–∞ üé±
- –ë—ã—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º
- –ù–µ –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º
- –ù–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ"""

            response = gemini_client.generate_text_response(prompt)

            if response and len(response.strip()) > 0:
                # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –∫–∞–≤—ã—á–∫–∏
                answer = response.strip().strip('"').strip("'")

                # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –æ—Ç–≤–µ—Ç–∞
                if len(answer) > 200:
                    answer = answer[:200] + "..."

                return f"üé± {answer}"
            else:
                # Fallback –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
                answers = [
                    "üé± –û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ –¥–∞!",
                    "üé± –ë–µ–∑ —Å–æ–º–Ω–µ–Ω–∏—è!",
                    "üé± –î–∞, –∫–æ–Ω–µ—á–Ω–æ!",
                    "üé± –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –¥–∞",
                    "üé± –ú–æ–∂–µ—Ç –±—ã—Ç—å...",
                    "üé± –¢—Ä—É–¥–Ω–æ —Å–∫–∞–∑–∞—Ç—å",
                    "üé± –õ—É—á—à–µ –Ω–µ —Å–µ–π—á–∞—Å",
                    "üé± –í—Ä—è–¥ –ª–∏",
                    "üé± –ù–µ—Ç, –Ω–∞–≤–µ—Ä–Ω–æ–µ",
                    "üé± –°–æ–≤—Å–µ–º –Ω–µ—Ç!",
                    "üé± –ù–∏–∫–æ–≥–¥–∞!",
                    "üé± –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑"
                ]
                return random.choice(answers)

        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ –≤–æ–ª—à–µ–±–Ω–æ–≥–æ —à–∞—Ä–∞: {e}")

            # Fallback –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –ø—Ä–∏ –æ—à–∏–±–∫–µ
            answers = [
                "üé± –û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ –¥–∞!",
                "üé± –ë–µ–∑ —Å–æ–º–Ω–µ–Ω–∏—è!",
                "üé± –î–∞, –∫–æ–Ω–µ—á–Ω–æ!",
                "üé± –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –¥–∞",
                "üé± –ú–æ–∂–µ—Ç –±—ã—Ç—å...",
                "üé± –¢—Ä—É–¥–Ω–æ —Å–∫–∞–∑–∞—Ç—å",
                "üé± –õ—É—á—à–µ –Ω–µ —Å–µ–π—á–∞—Å",
                "üé± –í—Ä—è–¥ –ª–∏",
                "üé± –ù–µ—Ç, –Ω–∞–≤–µ—Ä–Ω–æ–µ",
                "üé± –°–æ–≤—Å–µ–º –Ω–µ—Ç!",
                "üé± –ù–∏–∫–æ–≥–¥–∞!",
                "üé± –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑"
            ]
            return random.choice(answers)


class FunService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π."""

    def get_random_fact(self) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç —Å –ø–æ–º–æ—â—å—é –ò–ò –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π."""
        try:
            # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
            categories = [
                "–Ω–∞—É–∫–∞ –∏ –æ—Ç–∫—Ä—ã—Ç–∏—è",
                "–∂–∏–≤–æ—Ç–Ω—ã–µ –∏ –ø—Ä–∏—Ä–æ–¥–∞",
                "–∫–æ—Å–º–æ—Å –∏ –∞—Å—Ç—Ä–æ–Ω–æ–º–∏—è",
                "–∏—Å—Ç–æ—Ä–∏—è –∏ —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏–∏",
                "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –∏–∑–æ–±—Ä–µ—Ç–µ–Ω–∏—è",
                "—á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–µ —Ç–µ–ª–æ",
                "–æ–∫–µ–∞–Ω –∏ –º–æ—Ä—è",
                "—Ä–∞—Å—Ç–µ–Ω–∏—è –∏ —ç–∫–æ–ª–æ–≥–∏—è",
                "–ø–æ–≥–æ–¥–∞ –∏ –∫–ª–∏–º–∞—Ç",
                "–∞—Ä—Ö–µ–æ–ª–æ–≥–∏—è –∏ –¥—Ä–µ–≤–Ω–æ—Å—Ç–∏"
            ]

            selected_category = random.choice(categories)

            prompt = f"""–ü—Ä–∏–¥—É–º–∞–π –æ–¥–∏–Ω —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏ —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ñ–∞–∫—Ç –ø—Ä–æ {selected_category}.
            –§–∞–∫—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:
            - –ù–∞—Å—Ç–æ—è—â–∏–º –∏ –Ω–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–º
            - –ö–æ—Ä–æ—Ç–∫–∏–º (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
            - –ó–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏–º –∏ –º–∞–ª–æ–∏–∑–≤–µ—Å—Ç–Ω—ã–º
            - –ù–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
            - –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º –¥–ª—è —à–∏—Ä–æ–∫–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏

            –í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ —Å–∞–º —Ñ–∞–∫—Ç –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –æ–±—ä—è—Å–Ω–µ–Ω–∏–π –∏–ª–∏ —Å—Å—ã–ª–æ–∫."""

            fact = gemini_client.generate_text_response(prompt)

            if fact:
                # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
                fact = fact.strip()
                # –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                fact = fact.strip('"\'')
                return f"üß† <b>–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç:</b>\n\n{fact}"
            else:
                # Fallback —Ñ–∞–∫—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                fallbacks = {
                    "–Ω–∞—É–∫–∞ –∏ –æ—Ç–∫—Ä—ã—Ç–∏—è": "üß¨ –î–ù–ö –±—ã–ª–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –≤ 1953 –≥–æ–¥—É, –Ω–æ –¥–æ —Å–∏—Ö –ø–æ—Ä —É—á–µ–Ω—ã–µ –∏–∑—É—á–∞—é—Ç —Ç–æ–ª—å–∫–æ 2% –µ–µ —Ñ—É–Ω–∫—Ü–∏–π!",
                    "–∂–∏–≤–æ—Ç–Ω—ã–µ –∏ –ø—Ä–∏—Ä–æ–¥–∞": "üêò –°–∞–º—ã–π –±–æ–ª—å—à–æ–π —Å–ª–æ–Ω –≤ –∏—Å—Ç–æ—Ä–∏–∏ –≤–µ—Å–∏–ª —Ü–µ–ª—ã—Ö 12 —Ç–æ–Ω–Ω!",
                    "–∫–æ—Å–º–æ—Å –∏ –∞—Å—Ç—Ä–æ–Ω–æ–º–∏—è": "üåü –ó–≤–µ–∑–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –≤–∏–¥–∏–º –Ω–æ—á—å—é, –º–æ–≥—É—Ç —É–∂–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å!",
                    "–∏—Å—Ç–æ—Ä–∏—è –∏ —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏–∏": "üè∫ –î—Ä–µ–≤–Ω–∏–µ —Ä–∏–º–ª—è–Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –º–æ—á—É –∫–∞–∫ –æ—Ç–±–µ–ª–∏–≤–∞—Ç–µ–ª—å –¥–ª—è –∑—É–±–æ–≤!",
                    "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –∏–∑–æ–±—Ä–µ—Ç–µ–Ω–∏—è": "üí° –ü–µ—Ä–≤–∞—è –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–∞—è –º—ã—à—å –±—ã–ª–∞ —Å–¥–µ–ª–∞–Ω–∞ –∏–∑ –¥–µ—Ä–µ–≤–∞ –≤ 1964 –≥–æ–¥—É!",
                }
                return f"üß† <b>–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç:</b>\n\n{random.choice(list(fallbacks.values()))}"

        except Exception as e:
            log_error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–∞–∫—Ç–∞: {str(e)}")
            return "üß† <b>–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç:</b>\n\nüåç –ó–µ–º–ª—è –≤—Ä–∞—â–∞–µ—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º –∫–æ–≥–¥–∞-–ª–∏–±–æ –≤ –∏—Å—Ç–æ—Ä–∏–∏ —á–µ–ª–æ–≤–µ—á–µ—Å—Ç–≤–∞!"

    def get_motivational_quote(self) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—É—é –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—É—é —Ü–∏—Ç–∞—Ç—É —Å –ø–æ–º–æ—â—å—é –ò–ò –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π."""
        try:
            # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Ç–µ–º—É –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
            themes = [
                "—É—Å–ø–µ—Ö –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è",
                "–Ω–∞—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∏ –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–µ–π",
                "–º–µ—á—Ç—ã –∏ —Ü–µ–ª–∏",
                "—Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ –∏ –æ–±—É—á–µ–Ω–∏–µ",
                "—Ä–∞–±–æ—Ç–∞ –∏ –∫–∞—Ä—å–µ—Ä–∞",
                "–æ—Ç–Ω–æ—à–µ–Ω–∏—è –∏ –¥—Ä—É–∂–±–∞",
                "–∑–¥–æ—Ä–æ–≤—å–µ –∏ —Å–ø–æ—Ä—Ç",
                "—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ –∏ –∏—Å–∫—É—Å—Å—Ç–≤–æ",
                "–≤—Ä–µ–º—è –∏ –∂–∏–∑–Ω—å",
                "—Å—á–∞—Å—Ç—å–µ –∏ –ø–æ–∑–∏—Ç–∏–≤"
            ]

            selected_theme = random.choice(themes)

            prompt = f"""–°–æ–∑–¥–∞–π –æ–¥–Ω—É –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—É—é —Ü–∏—Ç–∞—Ç—É –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –ø—Ä–æ {selected_theme}.
            –¶–∏—Ç–∞—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å:
            - –ö–æ—Ä–æ—Ç–∫–æ–π –∏ –∑–∞–ø–æ–º–∏–Ω–∞—é—â–µ–π—Å—è (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
            - –ü–æ–∑–∏—Ç–∏–≤–Ω–æ–π –∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–µ–π
            - –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π (–Ω–µ –∫–æ–ø–∏—Ä—É–π –∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã)
            - –°–≤–µ–∂–µ–π –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π

            –í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ —Å–∞–º—É —Ü–∏—Ç–∞—Ç—É –±–µ–∑ –∫–∞–≤—ã—á–µ–∫, –∞–≤—Ç–æ—Ä–∞ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤."""

            quote = gemini_client.generate_text_response(prompt)

            if quote:
                # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
                quote = quote.strip()
                # –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                quote = quote.strip('"\'')
                return f"üí≠ <b>–ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞:</b>\n\n¬´{quote}¬ª"
            else:
                # Fallback —Ü–∏—Ç–∞—Ç—ã –ø–æ —Ç–µ–º–∞–º
                fallbacks = {
                    "—É—Å–ø–µ—Ö –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è": "¬´–£—Å–ø–µ—Ö - —ç—Ç–æ –Ω–µ –æ–∫–æ–Ω—á–∞–Ω–∏–µ, –Ω–µ—É–¥–∞—á–∞ - –Ω–µ —Ñ–∞—Ç–∞–ª—å–Ω–∞: —Å–º–µ–ª–æ—Å—Ç—å –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å - –≤–æ—Ç —á—Ç–æ –≤–∞–∂–Ω–æ!¬ª",
                    "–º–µ—á—Ç—ã –∏ —Ü–µ–ª–∏": "¬´–ë—É–¥—É—â–µ–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ç–µ–º, –∫—Ç–æ –≤–µ—Ä–∏—Ç –≤ –∫—Ä–∞—Å–æ—Ç—É —Å–≤–æ–∏—Ö –º–µ—á—Ç–∞–Ω–∏–π.¬ª",
                    "–Ω–∞—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å": "¬´–ù–µ –±–æ–π—Å—è –æ—Ç–∫–∞–∑–æ–≤. –ö–∞–∂–¥—ã–π –æ—Ç–∫–∞–∑ - —ç—Ç–æ —à–∞–≥ –±–ª–∏–∂–µ –∫ —É—Å–ø–µ—Ö—É.¬ª",
                    "—Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ": "¬´–í–∞—à–µ –≤—Ä–µ–º—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ, –Ω–µ —Ç—Ä–∞—Ç—å—Ç–µ –µ–≥–æ –Ω–∞ —á—É–∂—É—é –∂–∏–∑–Ω—å.¬ª",
                    "—Ä–∞–±–æ—Ç–∞": "¬´–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–¥–µ–ª–∞—Ç—å –≤–µ–ª–∏–∫—É—é —Ä–∞–±–æ—Ç—É - –ª—é–±–∏—Ç—å —Ç–æ, —á—Ç–æ –¥–µ–ª–∞–µ—à—å.¬ª",
                }
                return f"üí≠ <b>–ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞:</b>\n\n{random.choice(list(fallbacks.values()))}"

        except Exception as e:
            log_error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ü–∏—Ç–∞—Ç—ã: {str(e)}")
            return "üí≠ <b>–ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞:</b>\n\n¬´–ö–∞–∂–¥—ã–π –¥–µ–Ω—å - —ç—Ç–æ –Ω–æ–≤—ã–π —à–∞–Ω—Å —Å—Ç–∞—Ç—å –ª—É—á—à–µ.¬ª"

    def get_random_joke(self) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—É—é —à—É—Ç–∫—É —Å –ø–æ–º–æ—â—å—é –ò–ò —Å —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–º–∏ —Ç–µ–º–∞–º–∏."""
        try:
            # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
            categories = [
                "–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ IT",
                "–ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–∞—è –∂–∏–∑–Ω—å",
                "–∂–∏–≤–æ—Ç–Ω—ã–µ –∏ –ø—Ä–∏—Ä–æ–¥–∞",
                "–µ–¥–∞ –∏ –∫—É–ª–∏–Ω–∞—Ä–∏—è",
                "—Å–ø–æ—Ä—Ç –∏ –∑–¥–æ—Ä–æ–≤—å–µ",
                "—à–∫–æ–ª–∞ –∏ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ",
                "—Å–µ–º—å—è –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è",
                "–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è",
                "—Ç–µ—Ö–Ω–∏–∫–∞ –∏ –≥–∞–¥–∂–µ—Ç—ã",
                "–∏—Å–∫—É—Å—Å—Ç–≤–æ –∏ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ"
            ]

            selected_category = random.choice(categories)

            prompt = f"""–ü—Ä–∏–¥—É–º–∞–π –æ–¥–Ω—É –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –∏ —Å–º–µ—à–Ω—É—é —à—É—Ç–∫—É –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –ø—Ä–æ {selected_category}.
            –®—É—Ç–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å:
            - –ö–æ—Ä–æ—Ç–∫–æ–π –∏ –ø–æ–Ω—è—Ç–Ω–æ–π (1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
            - –ë–µ–∑ –≥—Ä—É–±–æ—Å—Ç–µ–π –∏ –æ–±–∏–¥–Ω—ã—Ö —Ç–µ–º
            - –ù–∞—Å—Ç–æ—è—â–µ–π —à—É—Ç–∫–æ–π (—Å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–º punchline)
            - –°–≤–µ–∂–µ–π –∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π

            –§–æ—Ä–º–∞—Ç: –≤–æ–ø—Ä–æ—Å + –æ—Ç–≤–µ—Ç –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Å–º–µ—à–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è.

            –í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ —Å–∞–º—É —à—É—Ç–∫—É –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –∫–∞–≤—ã—á–µ–∫ –∏–ª–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π."""

            joke = gemini_client.generate_text_response(prompt)

            if joke:
                # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
                joke = joke.strip()
                # –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                joke = joke.strip('"\'')
                return f"üòÇ <b>–®—É—Ç–∫–∞:</b>\n\n{joke}"
            else:
                # Fallback —à—É—Ç–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                fallbacks = {
                    "–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ IT": "ü§£ –ü–æ—á–µ–º—É –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—ã –ø—É—Ç–∞—é—Ç –•—ç–ª–ª–æ—É–∏–Ω –∏ –†–æ–∂–¥–µ—Å—Ç–≤–æ?\n–ü–æ—Ç–æ–º—É —á—Ç–æ Oct 31 = Dec 25!",
                    "–ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–∞—è –∂–∏–∑–Ω—å": "üòÑ –ü–æ—á–µ–º—É –∑–æ–Ω—Ç –Ω–µ –∏–¥–µ—Ç –≤ —à–∫–æ–ª—É?\n–ü–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω —É–∂–µ —Ä–∞—Å–∫—Ä—ã—Ç!",
                    "–∂–∏–≤–æ—Ç–Ω—ã–µ –∏ –ø—Ä–∏—Ä–æ–¥–∞": "üêò –ü–æ—á–µ–º—É —Å–ª–æ–Ω –Ω–µ –ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–º?\n–û–Ω –±–æ–∏—Ç—Å—è –º—ã—à–∫–∏!",
                    "–µ–¥–∞ –∏ –∫—É–ª–∏–Ω–∞—Ä–∏—è": "üçï –ü–æ—á–µ–º—É –ø–∏—Ü—Ü–∞ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—ã–≤–∞–µ—Ç –≥—Ä—É—Å—Ç–Ω–æ–π?\n–ü–æ—Ç–æ–º—É —á—Ç–æ —É –Ω–µ–µ –º–Ω–æ–≥–æ –¥—Ä—É–∑–µ–π —Å–≤–µ—Ä—Ö—É!",
                    "—Å–ø–æ—Ä—Ç –∏ –∑–¥–æ—Ä–æ–≤—å–µ": "‚öΩ –ü–æ—á–µ–º—É —Ñ—É—Ç–±–æ–ª–∏—Å—Ç—ã –≤—Å–µ–≥–¥–∞ –Ω–æ—Å—è—Ç —à–æ—Ä—Ç—ã?\n–ü–æ—Ç–æ–º—É —á—Ç–æ –≤ –¥–ª–∏–Ω–Ω—ã—Ö —à—Ç–∞–Ω–∞—Ö –Ω–µ –∑–∞–±—å–µ—à—å –≥–æ–ª!",
                }
                return f"üòÇ <b>–®—É—Ç–∫–∞:</b>\n\n{random.choice(list(fallbacks.values()))}"

        except Exception as e:
            log_error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —à—É—Ç–∫–∏: {str(e)}")
            return "üòÇ <b>–®—É—Ç–∫–∞:</b>\n\nüòÑ –ß—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç –∂–µ–Ω–µ?\n¬´–£ –º–µ–Ω—è –µ—Å—Ç—å –¥–≤–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ–±—è:\n1. –¢—ã —Å–∞–º–∞—è –∫—Ä–∞—Å–∏–≤–∞—è.\n2. –£—Å—Ç–∞–Ω–æ–≤–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ.¬ª"


# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã —Å–µ—Ä–≤–∏—Å–æ–≤
calculator = Calculator()
translator = Translator()
weather_service = WeatherService()
game_service = GameService()
fun_service = FunService()
